name: 自動打包所有平台版本

on:
  push:
    tags:
      - 'v*'  
  workflow_dispatch:  # 允許手動觸發

jobs:
  build-windows:
    name: 打包 Windows 版本
    runs-on: windows-latest
    
    steps:
    - name: 檢出代碼
      uses: actions/checkout@v4
    
    - name: 設定 Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: 安裝依賴
      run: |
        python -m pip install --upgrade pip
        pip install pandas openpyxl numpy pyinstaller
    
    - name: 獲取版本號
      id: get_version
      run: |
        if ("${{ github.ref }}" -like "refs/tags/*") {
          $version = "${{ github.ref }}" -replace 'refs/tags/', ''
        } else {
          $version = "dev"
        }
        echo "version=$version" >> $env:GITHUB_OUTPUT
      shell: pwsh
    
    - name: 打包 Windows 版本
      run: |
        pyinstaller --onefile --windowed --name="Replicates_eliminating_tool_${{ steps.get_version.outputs.version }}" ms_processor.py
    
    - name: 創建資料夾結構
      run: |
        $version = "${{ steps.get_version.outputs.version }}"
        $folderName = "Replicates_eliminating_tool_Win_$version"
        New-Item -ItemType Directory -Path $folderName
        New-Item -ItemType Directory -Path "$folderName\output"
        Move-Item "dist\Replicates_eliminating_tool_$version.exe" "$folderName\"
      shell: pwsh
    
    - name: 創建使用說明
      run: |
        $version = "${{ steps.get_version.outputs.version }}"
        $folderName = "Replicates_eliminating_tool_Win_$version"
        @"
        MS Data Replicates Eliminating Tool $version - Windows Version

        【How to Use】
        1. Double-click to run the program
        2. Select data file (supports Excel/CSV/TSV)
        3. Adjust parameters and click "Start Processing"
        4. Processed files will be saved in the "output" folder

        【System Requirements】
        Windows 7 or newer

        【Notes】
        - Output files will be automatically saved in the "output" folder
        - The output folder is in the same directory as the executable
        "@ | Out-File -FilePath "$folderName\README.txt" -Encoding UTF8
      shell: pwsh
    
    - name: 上傳 Windows 產物
      uses: actions/upload-artifact@v4
      with:
        name: Windows-版本
        path: Replicates_eliminating_tool_Win_${{ steps.get_version.outputs.version }}

  build-macos:
    name: 打包 macOS 版本
    runs-on: macos-latest
    
    steps:
    - name: 檢出代碼
      uses: actions/checkout@v4
    
    - name: 設定 Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: 安裝依賴
      run: |
        python -m pip install --upgrade pip
        pip install pandas openpyxl numpy pyinstaller
    
    - name: 獲取版本號
      id: get_version
      run: |
        if [[ "${{ github.ref }}" == refs/tags/* ]]; then
          version="${{ github.ref }}"
          version="${version#refs/tags/}"
        else
          version="dev"
        fi
        echo "version=$version" >> $GITHUB_OUTPUT
    
    - name: 打包 macOS 版本
      run: |
        pyinstaller --onefile --windowed --name="Replicates_eliminating_tool_${{ steps.get_version.outputs.version }}" ms_processor.py
    
    - name: 創建資料夾結構
      run: |
        version="${{ steps.get_version.outputs.version }}"
        folderName="Replicates_eliminating_tool_macOS_$version"
        mkdir -p "$folderName/output"
        mv "dist/Replicates_eliminating_tool_$version" "$folderName/"
        xattr -cr "$folderName/Replicates_eliminating_tool_$version" || true
    
    - name: 創建使用說明
      run: |
        version="${{ steps.get_version.outputs.version }}"
        folderName="Replicates_eliminating_tool_macOS_$version"
        cat > "$folderName/README.txt" << 'EOF'
        MS Data Replicates Eliminating Tool $version - macOS Version

        【How to Use】
        1. Double-click to run the program
        2. Select data file (supports Excel/CSV/TSV)
        3. Adjust parameters and click "Start Processing"
        4. Processed files will be saved in the "output" folder

        【First Run Important Notes】
        If you see "Cannot open because it is from an unidentified developer":

        Method 1 (Recommended):
          1. Right-click the program
          2. Select "Open"
          3. Click "Open" again to confirm

        Method 2:
          Run in Terminal: xattr -cr "Replicates_eliminating_tool_$version"

        Method 3:
          System Preferences → Security & Privacy → Open Anyway

        【System Requirements】
        macOS 10.13 (High Sierra) or newer

        【Notes】
        - Output files will be automatically saved in the "output" folder
        - The output folder is in the same directory as the executable
        EOF
        sed -i '' "s/\$version/$version/g" "$folderName/README.txt"
    
    - name: 上傳 macOS 產物
      uses: actions/upload-artifact@v4
      with:
        name: macOS-版本
        path: Replicates_eliminating_tool_macOS_${{ steps.get_version.outputs.version }}

  build-linux:
    name: 打包 Linux 版本
    runs-on: ubuntu-latest
    
    steps:
    - name: 檢出代碼
      uses: actions/checkout@v4
    
    - name: 設定 Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: 安裝依賴
      run: |
        python -m pip install --upgrade pip
        pip install pandas openpyxl numpy pyinstaller
    
    - name: 獲取版本號
      id: get_version
      run: |
        if [[ "${{ github.ref }}" == refs/tags/* ]]; then
          version="${{ github.ref }}"
          version="${version#refs/tags/}"
        else
          version="dev"
        fi
        echo "version=$version" >> $GITHUB_OUTPUT
    
    - name: 打包 Linux 版本
      run: |
        pyinstaller --onefile --windowed --name="Replicates_eliminating_tool_${{ steps.get_version.outputs.version }}" ms_processor.py
    
    - name: 創建資料夾結構
      run: |
        version="${{ steps.get_version.outputs.version }}"
        folderName="Replicates_eliminating_tool_Linux_$version"
        mkdir -p "$folderName/output"
        mv "dist/Replicates_eliminating_tool_$version" "$folderName/"
        chmod +x "$folderName/Replicates_eliminating_tool_$version"
    
    - name: 創建使用說明
      run: |
        version="${{ steps.get_version.outputs.version }}"
        folderName="Replicates_eliminating_tool_Linux_$version"
        cat > "$folderName/README.txt" << EOF
        MS Data Replicates Eliminating Tool $version - Linux Version

        【How to Use】
        1. Set execute permission: chmod +x Replicates_eliminating_tool_$version
        2. Run program: ./Replicates_eliminating_tool_$version
        3. Select data file (supports Excel/CSV/TSV)
        4. Adjust parameters and click "Start Processing"
        5. Processed files will be saved in the "output" folder

        【System Requirements】
        - Ubuntu 18.04+ / Debian 10+ / Fedora 30+ or compatible distributions
        - Requires X11 or Wayland display server

        【Notes】
        - Output files will be automatically saved in the "output" folder
        - The output folder is in the same directory as the executable
        EOF
    
    - name: 上傳 Linux 產物
      uses: actions/upload-artifact@v4
      with:
        name: Linux-版本
        path: Replicates_eliminating_tool_Linux_${{ steps.get_version.outputs.version }}

  create-release:
    name: 創建發布版本
    needs: [build-windows, build-macos, build-linux]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    
    steps:
    - name: 獲取版本號
      id: get_version
      run: |
        version="${{ github.ref }}"
        version="${version#refs/tags/}"
        echo "version=$version" >> $GITHUB_OUTPUT
    
    - name: 下載所有產物
      uses: actions/download-artifact@v4
    
    - name: 壓縮各平台檔案
      run: |
        version="${{ steps.get_version.outputs.version }}"
        cd Windows-版本
        zip -r "../Replicates_eliminating_tool_Win_$version.zip" "Replicates_eliminating_tool_Win_$version"
        cd ../macOS-版本
        zip -r "../Replicates_eliminating_tool_macOS_$version.zip" "Replicates_eliminating_tool_macOS_$version"
        cd ../Linux-版本
        zip -r "../Replicates_eliminating_tool_Linux_$version.zip" "Replicates_eliminating_tool_Linux_$version"
        cd ..
    
    - name: 創建 Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          Replicates_eliminating_tool_Win_${{ steps.get_version.outputs.version }}.zip
          Replicates_eliminating_tool_macOS_${{ steps.get_version.outputs.version }}.zip
          Replicates_eliminating_tool_Linux_${{ steps.get_version.outputs.version }}.zip
        body: |
          ## MS Data Replicates Eliminating Tool ${{ steps.get_version.outputs.version }}
          
          ### Features
          - Automatically identify RT, m/z, Intensity columns
          - Remove duplicate signals (based on tolerance)
          - Sort by intensity
          - Support Excel, CSV, TSV formats
          - Auto-save to output folder
          
          ### Download Instructions
          - **Windows Users**: Download `Replicates_eliminating_tool_Win_${{ steps.get_version.outputs.version }}.zip`
          - **Mac Users**: Download `Replicates_eliminating_tool_macOS_${{ steps.get_version.outputs.version }}.zip`
          - **Linux Users**: Download `Replicates_eliminating_tool_Linux_${{ steps.get_version.outputs.version }}.zip`
          
          Extract and read "README.txt" for instructions
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
